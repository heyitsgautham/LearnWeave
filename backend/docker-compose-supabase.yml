# ============================================
# LearnWeave - Local Testing with Supabase
# ============================================
# This setup uses:
# - Supabase for PostgreSQL database (cloud)
# - ChromaDB in Docker (local vector DB)
# - Backend in Docker
# No MySQL needed!

services:
  # ============================================
  # Backend Application
  # ============================================
  app:
    container_name: learnweave
    build:
      context: ..
      dockerfile: Dockerfile.cloudrun
    environment:
      - WORKERS=1
      - PORT=8080
      - GOOGLE_APPLICATION_CREDENTIALS=/home/app/web/google-credentials.json
      # ChromaDB runs on same container for local testing
      - CHROMA_HOST=localhost
      - CHROMA_PORT=8000
      - CHROMA_DB_URL=http://localhost:8000
    ports:
      - "8127:8080"
    env_file:
      - ./.env
    restart: always
    networks:
      - learnweave-network
    depends_on:
      - chromadb

  # ============================================
  # ChromaDB Vector Database (Local)
  # ============================================
  chromadb:
    container_name: learnweave-chromadb
    image: chromadb/chroma:latest
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - PERSIST_DIRECTORY=/chroma/chroma
      - CHROMA_SERVER_ALLOW_RESET=true
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    volumes:
      - chroma-data:/chroma/chroma
    ports:
      - "8001:8000"
    restart: always
    networks:
      - learnweave-network

volumes:
  chroma-data:
    driver: local

networks:
  learnweave-network:
    driver: bridge
