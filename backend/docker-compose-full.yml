version: '3.8'

services:
  # ============================================
  # MySQL Database (Optional - uncomment to use)
  # ============================================
  # Uncomment this section if you want MySQL in Docker
  # Then update .env: DB_HOST=mysql
  
  # mysql:
  #   container_name: learnweave-mysql
  #   image: mysql:8.0
  #   environment:
  #     MYSQL_ROOT_PASSWORD: root_password_change_me
  #     MYSQL_DATABASE: learnweave_db
  #     MYSQL_USER: learnweave_user
  #     MYSQL_PASSWORD: your_secure_password  # Match this with .env DB_PASSWORD
  #   ports:
  #     - "3306:3306"
  #   volumes:
  #     - mysql-data:/var/lib/mysql
  #   restart: always
  #   healthcheck:
  #     test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
  #     timeout: 20s
  #     retries: 10

  # ============================================
  # Backend Application
  # ============================================
  app:
    container_name: learnweave
    #image: learnweave:latest
    build:
      context: .
      dockerfile: Dockerfile
    environment:
      - WORKERS=1
      # Set Google credentials path for the container
      - GOOGLE_APPLICATION_CREDENTIALS=/home/app/web/google-credentials.json
    volumes:
      # Mount the Google credentials file
      - ./google-credentials.json:/home/app/web/google-credentials.json:ro
    ports:
      - "8127:8000"
    env_file:
      - ./.env
    # Uncomment if using MySQL in Docker (above)
    # depends_on:
    #   mysql:
    #     condition: service_healthy
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================
  # ChromaDB Vector Database
  # ============================================
  chromadb:
    container_name: learnweave-chromadb
    image: chromadb/chroma:latest
    environment:
      - CHROMA_SERVER_HOST=0.0.0.0
      - CHROMA_SERVER_HTTP_PORT=8000
      - PERSIST_DIRECTORY=/chroma/chroma
      - CHROMA_SERVER_ALLOW_RESET=true
      - CHROMA_SERVER_CORS_ALLOW_ORIGINS=["*"]
    volumes:
      - chroma-data:/chroma/chroma
    ports:
      - "8001:8000"
    restart: always

volumes:
  # Uncomment if using MySQL in Docker
  # mysql-data:
  #   driver: local
  chroma-data:
    driver: local
